
<!doctype html>
<html lang="hu">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<title>Kaputelefon</title>

	<link rel="canonical" href="https://getbootstrap.com/docs/4.0/examples/sticky-footer-navbar/">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>

	<style>
/* Sticky footer styles
-------------------------------------------------- */
html {
  position: relative;
  min-height: 100%;
}
body {
  /* Margin bottom by footer height */
  margin-bottom: 60px;
}
.footer {
  position: absolute;
  bottom: 0;
  width: 100%;
  /* Set the fixed height of the footer here */
  height: 60px;
  line-height: 60px; /* Vertically center the text there */
  background-color: #f5f5f5;
}


/* Custom page CSS
-------------------------------------------------- */
/* Not required for template or sticky footer method. */

body > .container {
  padding: 60px 15px 0;
}

.footer > .container {
  padding-right: 15px;
  padding-left: 15px;
}

code {
  font-size: 80%;
}

.hidden {
    display: none;
}

#urlText {
    width: 300px;
}
	</style>
</head>

<body>

<header>
	<nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-primary">
		<div class="container-fluid">
			<a class="navbar-brand" href="#">Kaputelefon</a>
			<button id="navbar-toggler" class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarSupportedContent">
				<ul class="navbar-nav me-auto mb-2 mb-lg-0">
					<li class="nav-item">
						<a class="nav-link" href="#settings" onclick="menu(this)">Beállítások</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#phonebook" onclick="menu(this)">Telefonkönyv</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#admin" onclick="menu(this)">Szervíz</a>
					</li>
				</ul>
				<div class="d-flex">
					<input class="form-control" placeholder="Url" id="urlText">
				</div>
			</div>
		</div>
	</nav>
</header>

<!-- Begin page content -->
<main role="main" class="container">

	<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5; width: 200px;">
		<div id="liveToast" class="toast align-items-center hide" role="alert" aria-live="assertive" aria-atomic="true">
			<div class="toast-header text-white bg-primary">
				<strong class="me-auto">Info</strong>
				<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
			</div>
			<div class="toast-body" id="alertText">
			</div>
		</div>
	</div>

	<div class="page hidden" id="admin">
		<div class="card">
			<div class="card-body">
				<div class="mb-3">
					<button type="button" class="btn btn-primary" onclick="restart()">Újraindítás</button>
				</div>
				<div class="mb-3">
					<button type="button" class="btn btn-primary" onclick="factoryReset()">Gyári beállítások visszaállítása</button>
				</div>
				<div class="mb-3">
					<form action="/api/ota">
						<div class="mb-3">
							<label for="otaTextArea">OTA</label>
							<textarea name="otaTextArea" class="form-control" id="otaTextArea"></textarea>
						</div>
						<button type="submit" class="btn btn-primary">Mentés</button>
					</form>
				</div>
			</div>
		</div>
	</div>
	<div class="page hidden" id="phonebook">
		<div class="card">
			<div class="card-body">
				<form action="/file/contacts">
					<div class="mb-3">
						<label for="contactsTextArea">Kapcsolatok</label>
						<textarea name="contactsTextArea" class="form-control" id="contactsTextArea"></textarea>
					</div>
					<button type="submit" class="btn btn-primary">Mentés</button>
				</form>
			</div>
		</div>
	</div>
	<div class="page hidden" id="settings">
		<div class="accordion" id="accordionExample">
			<div class="accordion-item">
				<h2 class="accordion-header" id="headingOne">
					<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
						Wifi beállítások
					</button>
				</h2>
				<div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
					<div class="accordion-body">
						<form action="/api/wifi_settings">
							<div class="mb-3">
								<label for="ssidText">SSID</label>
								<input name="ssid" type="text" class="form-control" id="ssidText" placeholder="SSID">
							</div>
							<div class="mb-3">
								<label for="passwordText">Jelszó</label>
								<input name="password" type="text" class="form-control" id="passwordText" placeholder="Jelszó">
							</div>
							<button type="submit" class="btn btn-primary">Mentés</button>
						</form>
					</div>
				</div>
			</div>
			<div class="accordion-item">
				<h2 class="accordion-header" id="headingTwo">
					<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
						SIP beállítások
					</button>
				</h2>
				<div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
					<div class="accordion-body">
						<form action="/file/accounts">
							<div class="mb-3">
								<label for="accountsTextArea">SIP beállítások</label>
								<textarea name="accountsTextArea" class="form-control" id="accountsTextArea"></textarea>
							</div>
							<button type="submit" class="btn btn-primary">Mentés</button>
						</form>
					</div>
				</div>
			</div>
			<div class="accordion-item">
				<h2 class="accordion-header" id="headingThree">
					<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
						Kapu beállítások
					</button>
				</h2>
				<div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionExample">
					<div class="accordion-body">
						<form action="/api/icom">
							<div class="mb-3">
								<label for="gvolText">Csengetés hangerő</label>
								<input name="gvol" type="text" class="form-control" id="gvolText" placeholder="Csengetés hangerő">
							</div>
							<div class="mb-3">
								<label for="rvolText">Ajtócsengő hangerő</label>
								<input name="rvol" type="text" class="form-control" id="rvolText" placeholder="Ajtócsengő hangerő">
							</div>
							<div class="mb-3">
								<label for="cvolText">Beep hangerő</label>
								<input name="cvol" type="text" class="form-control" id="cvolText" placeholder="Beep hangerő">
							</div>
							<div class="mb-3">
								<label for="hvolText">Fejhallgató hangerő</label>
								<input name="hvol" type="text" class="form-control" id="hvolText" placeholder="Fejhallgató hangerő">
							</div>
							<div class="mb-3">
								<label for="mvolText">Mikrofon hangerő</label>
								<input name="mvol" type="text" class="form-control" id="mvolText" placeholder="Mikrofon hangerő">
							</div>
							<div class="mb-3">
								<label for="typeSelect">Kaputelefon típusa</label>
								<select name="type" class="form-select" id="typeSelect">
									<option selected>Válasszon...</option>
									<option value="codefon">Codefon</option>
									<option value="mkt">MKT</option>
									<option value="laskome">Laskomex</option>
								</select>
							</div>
							<div class="mb-3">
								<label for="codeText">Kapukód</label>
								<input name="code" type="text" class="form-control" id="codeText" placeholder="Kapukód">
							</div>
							<button type="submit" class="btn btn-primary">Mentés</button>
						</form>
					</div>

				</div>
			</div>
		</div>
	</div>
</main>

<script>
function jsonToForm(f, data) {
  var options = {
    data: data || null
  };

  if (options.data != null) {
    for (k in options.data) {
      var v = options.data[k];
      var elements = $('[name^="' + k + '"]', f);

      $(elements).each(function (index, element) {
        if (Array.isArray(v)) {
          v.forEach(function (val) {
            $(element).is("select")
              ? $(element)
                  .find("[value='" + val + "']")
                  .prop("selected", true)
              : $(element).val() == val
              ? $(element).prop("checked", true)
              : "";
          });
        } else if ($(element).is(":checkbox") || $(element).is(":radio")) {
          // checkbox group or radio group
          $(element).val() == v ? $(element).prop("checked", true) : "";
        } else {
          $('[name="' + k + '"]', f).val(v);
        }
      });
    };
  }
};
</script>

<script>
var url = 'http://kaputelefon.no-ip.hu';

$( document ).ready(function () {
    $('#urlText').on('change', function() {
        url = $( this ).val();
        localStorage.setItem("urlText", url);
    });

    document.querySelectorAll('form').forEach(function(form) {
    	loadForm(form);
    	form.addEventListener('submit', saveForm);
    });
    let urlText = localStorage.getItem("urlText");
    if (urlText != null) {
    	url = urlText;
    }
    $('#urlText').val(url);
    bsCollapse = new bootstrap.Collapse(document.getElementById('navbarSupportedContent'));
    toast = new bootstrap.Toast(document.getElementById('liveToast'));
});

function showAlert(msg) {
	$('#alertText').html(msg);
	toast.show();
}

function loadForm(form) {
	let action = form.getAttribute('action');
	if (action != null && action != '/api/ota') {
		let isFile = action.startsWith('/file/');
		$.ajax({
			url: url + action,
			type: 'GET',
			success: function(data) {
				if (isFile) {
					form.getElementsByTagName('textarea')[0].value = data;
				} else {
					jsonToForm(form, data);
				}
			},
			error: function(result) {
				showAlert('error');
			}
		});
	}
}

function saveForm(event) {
	event.preventDefault();
	let form = event.target;
	let action = form.getAttribute('action');
	if (action != null) {
		let isFile = action.startsWith('/file/');
	    $.ajax({
			url: url + action,
			type: 'PUT',
			contentType: "application/json",
			data: isFile ?
				form.getElementsByTagName('textarea')[0].value
				:
				JSON.stringify(Object.fromEntries(new FormData(event.target).entries())),
			success: function(result) {
				showAlert(result);
			},
			error: function(result) {
				showAlert('error');
			}
		});
	}
}

function menu(l) {
    page = l.getAttribute('href');
    $('.page').each(function() {
        e = $( this );
        if(page == '#' + e.attr('id')) {
        	if ($("#navbar-toggler").is(":visible")) {
            	bsCollapse.hide();
            }
            e.removeClass( 'hidden' );
        } else {
            e.addClass( 'hidden' );
        }
    });
}

function restart() {
    $.ajax({
        url: url + '/api/restart',
        type: 'GET',
        success: function(result) {
            showAlert(result);
        },
        error: function(result) {
            showAlert('error');
        }
    });
}

function factoryReset() {
    $.ajax({
        url: url + '/api/factory_reset',
        type: 'GET',
        success: function(result) {
            showAlert(result);
        },
        error: function(result) {
            showAlert('error');
        }
    });
}
</script>
</body>
</html>
