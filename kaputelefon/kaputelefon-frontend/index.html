
<!doctype html>
<html lang="hu">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<title>Kaputelefon</title>

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>

	<style>
/* Sticky footer styles
-------------------------------------------------- */
html {
  position: relative;
  min-height: 100%;
}
body {
  /* Margin bottom by footer height */
  margin-bottom: 60px;
}
.footer {
  position: absolute;
  bottom: 0;
  width: 100%;
  /* Set the fixed height of the footer here */
  height: 60px;
  line-height: 60px; /* Vertically center the text there */
  background-color: #f5f5f5;
}


/* Custom page CSS
-------------------------------------------------- */
/* Not required for template or sticky footer method. */

body > .container {
  padding: 60px 15px 0;
}

.footer > .container {
  padding-right: 15px;
  padding-left: 15px;
}

code {
  font-size: 80%;
}

.hidden {
    display: none;
}

#urlText {
    width: 300px;
}
	</style>
</head>

<body>

<header>
	<nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-primary">
		<div class="container-fluid">
			<a class="navbar-brand" href="#">Kaputelefon</a>
			<button id="navbar-toggler" class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarSupportedContent">
				<ul class="navbar-nav me-auto mb-2 mb-lg-0">
					<li class="nav-item">
						<a class="nav-link" href="#settings" onclick="menu(this)">Beállítások</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#phonebook" onclick="menu(this)">Telefonkönyv</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#admin" onclick="menu(this)">Szervíz</a>
					</li>
				</ul>
				<div class="d-flex">
					<input class="form-control" placeholder="Url" id="urlText">
				</div>
			</div>
		</div>
	</nav>
</header>

<!-- Begin page content -->
<main role="main" class="container">

	<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5; width: 200px;">
		<div id="toastInfo" class="toast align-items-center hide" role="alert" aria-live="assertive" aria-atomic="true">
			<div class="toast-header text-white bg-success">
				<strong class="me-auto">Üzenet</strong>
				<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
			</div>
			<div class="toast-body" id="infoText">
			</div>
		</div>
	</div>
	<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5; width: 200px;">
		<div id="toastError" class="toast align-items-center hide" role="alert" aria-live="assertive" aria-atomic="true">
			<div class="toast-header text-white bg-danger">
				<strong class="me-auto">Hiba</strong>
				<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
			</div>
			<div class="toast-body" id="errorText">
			</div>
		</div>
	</div>

	<div class="page hidden" id="settings">
		<div class="accordion" id="accordionExample">
			<div class="accordion-item">
				<h2 class="accordion-header" id="headingOne">
					<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
						Wifi beállítások
					</button>
				</h2>
				<div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
					<div class="accordion-body">
						<form action="/api/wifi_settings">
							<div class="mb-3">
								<label for="ssidText">SSID</label>
								<input name="ssid" type="text" class="form-control" id="ssidText" placeholder="SSID">
							</div>
							<div class="mb-3">
								<label for="passwordText">Jelszó</label>
								<input name="password" type="text" class="form-control" id="passwordText" placeholder="Jelszó">
							</div>
							<button type="submit" class="btn btn-primary">Mentés</button>
						</form>
					</div>
				</div>
			</div>
			<div class="accordion-item">
				<h2 class="accordion-header" id="headingTwo">
					<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
						SIP beállítások
					</button>
				</h2>
				<div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
					<div class="accordion-body">
						<form action="/file/accounts">
							<div class="mb-3">
								<label for="accountsTextArea">SIP beállítások</label>
								<textarea name="accountsTextArea" class="form-control" id="accountsTextArea"></textarea>
							</div>
							<button type="submit" class="btn btn-primary">Mentés</button>
						</form>
					</div>
				</div>
			</div>
			<div class="accordion-item">
				<h2 class="accordion-header" id="headingThree">
					<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
						Kapu beállítások
					</button>
				</h2>
				<div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionExample">
					<div class="accordion-body">
						<form action="/api/icom">
							<div class="mb-3">
								<label for="gvolText">Csengetés hangerő</label>
								<input name="gvol" type="text" class="form-control" id="gvolText" placeholder="Csengetés hangerő">
							</div>
							<div class="mb-3">
								<label for="rvolText">Ajtócsengő hangerő</label>
								<input name="rvol" type="text" class="form-control" id="rvolText" placeholder="Ajtócsengő hangerő">
							</div>
							<div class="mb-3">
								<label for="cvolText">Beep hangerő</label>
								<input name="cvol" type="text" class="form-control" id="cvolText" placeholder="Beep hangerő">
							</div>
							<div class="mb-3">
								<label for="hvolText">Fejhallgató hangerő</label>
								<input name="hvol" type="text" class="form-control" id="hvolText" placeholder="Fejhallgató hangerő">
							</div>
							<div class="mb-3">
								<label for="mvolText">Mikrofon hangerő</label>
								<input name="mvol" type="text" class="form-control" id="mvolText" placeholder="Mikrofon hangerő">
							</div>
							<div class="mb-3">
								<label for="typeSelect">Kaputelefon típusa</label>
								<select name="type" class="form-select" id="typeSelect">
									<option selected>Válasszon...</option>
									<option value="codefon">Codefon</option>
									<option value="mkt">MKT</option>
									<option value="laskomex">Laskomex</option>
								</select>
							</div>
							<div class="mb-3">
								<label for="codeText">Kapukód</label>
								<input name="code" type="text" class="form-control" id="codeText" placeholder="Kapukód">
							</div>
							<button type="submit" class="btn btn-primary">Mentés</button>
						</form>
					</div>

				</div>
			</div>
		</div>
	</div>

	<div class="page hidden" id="phonebook">
		<div class="card">
			<div class="card-body">
				<form action="/file/contacts">
					<div class="mb-3">
						<label for="contactsTextArea">Kapcsolatok</label>
						<textarea name="contactsTextArea" class="form-control" id="contactsTextArea"></textarea>
					</div>
					<button type="submit" class="btn btn-primary">Mentés</button>
				</form>
			</div>
		</div>
	</div>

	<div class="page hidden" id="admin">
		<div class="card">
			<div class="card-body">
				<div class="mb-3">
					<button type="button" class="btn btn-primary" onclick="restart()">Újraindítás</button>
				</div>
				<div class="mb-3">
					<button type="button" class="btn btn-primary" onclick="factoryReset()">Gyári beállítások visszaállítása</button>
				</div>
			</div>
		</div>
		<div class="card">
			<div class="card-body">
				<pre id="codeBlock"></pre>
				<button type="button" class="btn btn-primary" onclick="showSettings()">Összes beállítás mutatása</button>
			</div>
		</div>
		<div class="card">
			<div class="card-body">
					<form action="/api/ota">
						<input id="input-b2" name="input-b2" type="file" class="file" data-show-preview="false">
						<button type="submit" class="btn btn-primary">Feltöltés</button>
					</form>
			</div>
		</div>
		<div class="card">
			<div class="card-body">
				<form action="/">
					<div class="mb-3">
						<label for="accountsTextArea">Index</label>
						<textarea name="accountsTextArea" class="form-control" id="accountsTextArea"></textarea>
					</div>
					<button type="submit" class="btn btn-primary">Mentés</button>
				</form>
			</div>
		</div>
	</div>
</main>

<script>
var url = 'http://kaputelefon.no-ip.hu';

document.addEventListener("DOMContentLoaded", function(event) {
	initGui();
	initUrlText();
	initForms();
});

function initGui() {
    bsCollapse = new bootstrap.Collapse(document.getElementById('navbarSupportedContent'));
    toastInfo = new bootstrap.Toast(document.getElementById('toastInfo'));
	toastError = new bootstrap.Toast(document.getElementById('toastError'));
}

function initForms() {
	document.querySelectorAll('form').forEach(function(form) {
		loadForm(form);
		form.addEventListener('submit', saveForm);
	});
}

function initUrlText() {
	let urlText = localStorage.getItem("urlText");
    if (urlText != null) {
    	url = urlText;
    }
	document.querySelector('#urlText').value = url;
	document.querySelector('#urlText').addEventListener('change', function() {
        url = this.value;
        localStorage.setItem("urlText", url);
    });
}

function jsonToForm(f, data) {
	for(var prop in data){
		f.querySelector('*[name='+prop+']').value = data[prop];
	}
};

function showInfo(msg) {
	document.querySelector('#infoText').innerHTML = msg;
	toastInfo.show();
}

function showError(msg) {
	document.querySelector('#errorText').innerHTML = msg;
	toastError.show();
}

function isFileAction(action) {
	return action != null && (action.startsWith('/file/') || action == '/'  || isOtaAction(action));
}

function isOtaAction(action) {
	return action == '/api/ota';
}

function ajax(protocol, action, success, data) {
	let isFile = isFileAction(action);
	let xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if (this.readyState == 4) {
			if (this.status == 200) {
				if (success != null) {
					success(this, isFile);
				} else {
					showInfo(this.responseText);
				}
			} else {
				showError(this.status + ": " + this.statusText);
			}
		}
	};
	xhttp.open(protocol, url + action, true);
	xhttp.send(data);
}

function loadForm(form) {
	let action = form.getAttribute('action');

	if (action != null && !isOtaAction(action)) {
		let isFile = isFileAction(action);
		ajax('GET', action, function(response, isFile) {
			if (isFile) {
				form.getElementsByTagName('textarea')[0].value = response.responseText;
			} else {
				jsonToForm(form, JSON.parse(response.responseText));
			}
		});
	}
}

function saveForm(event) {
	event.preventDefault();
	let form = event.target;
	let action = form.getAttribute('action');
	if (action != null) {
		let d = null;
		if (isFileAction(action)) {
			d = form.getElementsByTagName('textarea')[0].value;
		} else {
			action += '?' + new URLSearchParams(new FormData(event.target)).toString();
		}
	    ajax('PUT', action, null, d);
	}
}

function menu(l) {
    page = l.getAttribute('href');
    document.querySelectorAll('.page').forEach(function(item) {
        if(page == '#' + item.id) {
        	if (document.querySelector("#navbar-toggler").offsetLeft >= 0) {
            	bsCollapse.hide();
            }
            item.classList.remove( 'hidden' );
        } else {
            item.classList.add( 'hidden' );
        }
    });
}

function showSettings() {
    ajax('GET', '/settingses/1', function(response) {
		o = JSON.parse(response.responseText);
    	delete o.indexPage;
    	delete o._links;
		document.getElementById('codeBlock').innerHTML = JSON.stringify(o, null, 3);
	});
}

function restart() {
    ajax('GET', '/api/restart');
}

function factoryReset() {
    ajax('GET', '/api/factory_reset');
}
</script>
</body>
</html>
