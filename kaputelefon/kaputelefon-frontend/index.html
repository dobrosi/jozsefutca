<!doctype html>
<html lang="hu">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<title>Kaputelefon</title>

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>

	<style>
		body > .container {
		padding: 60px 15px 0;
		}

		.footer > .container {
		padding-right: 15px;
		padding-left: 15px;
		}

		code {
		font-size: 80%;
		}

		.hidden {
			display: none;
		}

		#urlText {
			width: 300px;
		}
	</style>
</head>

<body>

<header>
	<nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-primary">
		<div class="container-fluid">
			<a class="navbar-brand" href="#">Kaputelefon</a>
			<button id="navbar-toggler" class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarSupportedContent">
				<ul class="navbar-nav me-auto mb-2 mb-lg-0">
					<li class="nav-item">
						<a class="nav-link" href="#settings" onclick="menu(this)">Beállítások</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#phonebook" onclick="menu(this)">Telefonkönyv</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#admin" onclick="menu(this)">Szervíz</a>
					</li>
				</ul>
			</div>
		</div>
	</nav>
</header>

<!-- Begin page content -->
<main role="main" class="container">

	<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5; width: 200px;">
		<div id="toastInfo" class="toast align-items-center hide" role="alert" aria-live="assertive" aria-atomic="true">
			<div class="toast-header text-white bg-success">
				<strong class="me-auto">Üzenet</strong>
				<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
			</div>
			<div class="toast-body" id="infoText">
			</div>
		</div>
	</div>
	<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5; width: 200px;">
		<div id="toastError" class="toast align-items-center hide" role="alert" aria-live="assertive" aria-atomic="true">
			<div class="toast-header text-white bg-danger">
				<strong class="me-auto">Hiba</strong>
				<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
			</div>
			<div class="toast-body" id="errorText">
			</div>
		</div>
	</div>

	<div class="page hidden" id="settings">
		<div class="accordion" id="accordionSettings">
			<div class="accordion-item">
				<h2 class="accordion-header" id="headingOne">
					<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
						Wifi beállítások
					</button>
				</h2>
				<div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionSettings">
					<div class="accordion-body">
						<form action="/api/auth" class="needs-validation" novalidate>
							<div class="mb-3">
								<label for="ssidText">SSID</label>
								<input name="ssid" type="text" class="form-control" id="ssidText" placeholder="SSID" required>
								<div class="invalid-feedback">Kötelező értéket megadni.</div>
							</div>
							<div class="mb-3">
								<label for="passwordText">Jelszó</label>
								<input name="password" type="text" class="form-control" id="passwordText" placeholder="Jelszó" required>
								<div class="invalid-feedback">Kötelező értéket megadni.</div>
							</div>
							<button type="submit" class="btn btn-primary">Mentés</button>
						</form>
					</div>
				</div>
			</div>
			<div class="accordion-item">
				<h2 class="accordion-header" id="headingTwo">
					<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
						SIP beállítások
					</button>
				</h2>
				<div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionSettings">
					<div class="accordion-body">
						<form id="accountForm" class="needs-validation" novalidate>
							<div class="mb-3">
								<label for="accountSipTextField">SIP</label>
								<input name="accountSipTextField" type="text" class="form-control" id="accountSipTextField" placeholder="SIP" required>
								<div class="invalid-feedback">Kötelező értéket megadni.</div>
								<label for="accountPasswordTextField">Jelszó</label>
								<input name="accountPasswordTextField" type="text" class="form-control" id="accountPasswordTextField" placeholder="Jelszó" required>
								<div class="invalid-feedback">Kötelező értéket megadni.</div>
								<label for="accountOutboundTextField">Outbound</label>
								<input name="accountOutboundTextField" type="text" class="form-control" id="accountOutboundTextField" placeholder="Outbound">
							</div>
							<button type="submit" class="btn btn-primary">Mentés</button>
						</form>
					</div>
				</div>
			</div>
			<div class="accordion-item">
				<h2 class="accordion-header" id="headingThree">
					<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
						Kapu beállítások
					</button>
				</h2>
				<div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionSettings">
					<div class="accordion-body">
						<form action="/api/icom" class="needs-validation" novalidate>
							<div class="mb-3 kt-advanced">
								<label for="ivolText">Csengetés hangerő</label>
								<input name="ivol" type="number" class="form-control" id="ivolText" placeholder="Csengetés hangerő" min="0" max="255" required>
								<div class="invalid-feedback">0-255 tartományban választott értéket kötelező megadni.</div>
							</div>
							<div class="mb-3 kt-advanced">
								<label for="rvolText">Ajtócsengő hangerő</label>
								<input name="rvol" type="number" class="form-control" id="rvolText" placeholder="Ajtócsengő hangerő" min="0" max="255" required>
								<div class="invalid-feedback">0-255 tartományban választott értéket kötelező megadni.</div>
							</div>
							<div class="mb-3 kt-advanced">
								<label for="cvolText">Beep hangerő</label>
								<input name="cvol" type="number" class="form-control" id="cvolText" placeholder="Beep hangerő" min="0" max="255" required>
								<div class="invalid-feedback">0-255 tartományban választott értéket kötelező megadni.</div>
							</div>
							<div class="mb-3 kt-advanced">
								<label for="hvolText">Fejhallgató hangerő</label>
								<input name="hvol" type="number" class="form-control" id="hvolText" placeholder="Fejhallgató hangerő" min="0" max="255" required>
								<div class="invalid-feedback">0-255 tartományban választott értéket kötelező megadni.</div>
							</div>
							<div class="mb-3 kt-advanced">
								<label for="mvolText">Mikrofon hangerő</label>
								<input name="mvol" type="number" class="form-control" id="mvolText" placeholder="Mikrofon hangerő" min="0" max="255" required>
								<div class="invalid-feedback">0-255 tartományban választott értéket kötelező megadni.</div>
							</div>
							<div class="mb-3">
								<label for="typeSelect">Kaputelefon típusa</label>
								<select name="type" class="form-select" id="typeSelect" aria-placeholder="Válasszon..." required>
									<option value="codefon">Codefon</option>
									<option value="mkt">MKT</option>
									<option value="laskomex">Laskomex</option>
								</select>
							</div>
							<div class="mb-3 kt-advanced">
								<label for="codeText">Kapukód</label>
								<input name="code" type="number" class="form-control" id="codeText" placeholder="Kapukód" min="100" max="999" required>
								<div class="invalid-feedback">100-999 tartományban választott értéket kötelező megadni.</div>
							</div>
							<button type="submit" class="btn btn-primary">Mentés</button>
						</form>
					</div>

				</div>
			</div>
		</div>
	</div>

	<div class="page hidden" id="phonebook">
		<div class="card">
			<div class="card-body">
				<form id="phonebookForm" class="needs-validation" novalidate>
					<div class="mb-3 kt-contact">
						<label for="name1TextField">Név</label>
						<input name="name1TextField" type="text" class="form-control" id="name1TextField" placeholder="Név" required>
						<div class="invalid-feedback">Kötelező értéket megadni.</div>
						<label for="sip1TextField">SIP</label>
						<input name="sip1TextField" type="text" class="form-control" id="sip1TextField" placeholder="SIP" required>
						<div class="invalid-feedback">Kötelező értéket megadni.</div>
					</div>
					<div class="mb-3 kt-contact">
						<label for="name2TextField">Név</label>
						<input name="name2TextField" type="text" class="form-control" id="name2TextField" placeholder="Név">
						<label for="sip2TextField">SIP</label>
						<input name="sip2TextField" type="text" class="form-control" id="sip2TextField" placeholder="SIP">
					</div>
					<button type="submit" class="btn btn-primary">Mentés</button>
				</form>
			</div>
		</div>
	</div>

	<div class="page hidden" id="admin">
		<div class="card">
			<div class="card-body">
				<div class="mb-3">
					<label for="advancedSwitcher">Haladó beállítások</label>
					<input id="advancedSwitcher" name="advancedSwitcher" type="checkbox">
				</div>
				<div class="mb-3">
					<button type="button" class="btn btn-primary" onclick="testCall()">Próba hívás</button>
					<button type="button" class="btn btn-primary" onclick="testClientCall()">Próba hívás (kliens)</button>
					<div class="btn-group" role="group">
						<button type="button" class="btn btn-primary" onclick="getVersion()">Verzió</button>
						<button type="button" class="btn btn-primary" onclick="getMac()">MAC</button>
					</div>
					<div class="btn-group" role="group">
						<button type="button" class="btn btn-primary" onclick="restart()">Újraindítás</button>
						<button type="button" class="btn btn-primary" onclick="factoryReset()">Gyári beállítások visszaállítása</button>
					</div>
				</div>
				<div class="mb-3 kt-advanced">
					<label for="urlText">Kaputelefon URL</label>
					<input class="form-control" placeholder="Url" id="urlText">
				</div>
			</div>
		</div>

		<div class="card kt-advanced">
			<div class="card-body">
				<div class="accordion" id="accordionAdmin">
					<div class="accordion-item">
						<h2 class="accordion-header" id="headingAdminOne">
							<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdminOne" aria-expanded="true" aria-controls="collapseAdminOne">
								Log
							</button>
						</h2>
						<div class="card">
							<div class="card-body">
								<div id="collapseAdminOne" class="accordion-collapse collapse"  aria-labelledby="headingAdminOne" data-bs-parent="#accordionAdmin">
									<label for="logsleep">Lekérdezések közötti várakozás ideje másodpercben</label>
									<select name="logsleep" class="form-select" id="logsleep">
										<option value="-1">Ne logoljon</option>
										<option value="0">0</option>
										<option value="1">1</option>
										<option value="3">3</option>
										<option value="5">5</option>
										<option value="10">10</option>
										<option value="15">15</option>
										<option value="30">30</option>
										<option value="60">60</option>
									</select>
									<textarea class="form-control" name="logfile" id="logfile" rows="20" readonly></textarea>
									<button type="button" class="btn btn-primary" onclick="clearLogfile()">Log törlése</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<div class="card kt-advanced">
			<div class="card-body">
				<pre id="codeBlock"></pre>
				<button type="button" class="btn btn-primary" onclick="showSettings()">Összes beállítás mutatása</button>
			</div>
		</div>

		<div class="card kt-advanced">
			<div class="card-body">
				<form action="/api/settings" class="needs-validation" novalidate>
					<div class="mb-3 kt-advanced">
						<label for="testmodeText">Test mode</label>
						<input name="testmode" type="number" class="form-control" id="testmodeText" placeholder="Test mode" readonly>
					</div>
					<div class="mb-3 kt-advanced">
						<label for="ctimText">Timeout</label>
						<input name="ctim" type="number" class="form-control" id="ctimText" placeholder="Timeout" min="0" max="255" required>
						<div class="invalid-feedback">Kötelező értéket megadni.</div>
					</div>
					<button type="submit" class="btn btn-primary">Mentés</button>
				</form>
			</div>
		</div>

		<div class="card kt-advanced">
			<div class="card-body">
					<form id="otaFileForm" class="needs-validation" novalidate>
						<label for="indexFile">Firmware fájl</label>
						<input id="otaFile" name="otaFile" type="file" class="file" data-show-preview="false" required>
						<div class="invalid-feedback">Kötelező fájlt kiválasztani.</div>
						<button type="submit" class="btn btn-primary">Feltöltés</button>
					</form>
			</div>
		</div>

		<div class="card kt-advanced">
			<div class="card-body">
				<form id="indexFileForm" class="needs-validation" novalidate>
					<div class="mb-3">
						<label for="indexFile">Index fájl</label>
						<input id="indexFile" name="indexFile" type="file" class="file" data-show-preview="false" required>
						<div class="invalid-feedback">Kötelező fájlt kiválasztani.</div>
						<button type="submit" class="btn btn-primary">Feltöltés</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</main>

<script>
var configuration = {
	url: document.location.href,
	advancedMode: false
};

var actionContacts = '/file/contacts';
var actionAccounts = '/file/accounts';
var logfile;
var logTimeout;

document.addEventListener("DOMContentLoaded", function(event) {
	try {
		let newConfiguration = JSON.parse(localStorage.getItem("configuration"));
		if (newConfiguration != null && newConfiguration.url !== "") {
			configuration = newConfiguration;
		}
	} catch (e) {
		console.log(e);
	}
	initGui();
});


function testClientCall() {
	alert("Comming soon.");
}

function initGui() {
    bsCollapse = new bootstrap.Collapse(document.getElementById('navbarSupportedContent'));
    toastInfo = new bootstrap.Toast(document.getElementById('toastInfo'));
	toastError = new bootstrap.Toast(document.getElementById('toastError'));
	initUrlText();
	initAdvancedMode();
	initForms();
	initLogfile();
}

function initForms() {
	document.querySelectorAll('form').forEach(function(form) {
		loadForm(form);
		form.addEventListener('submit', function(event) {
			if (!form.checkValidity()) {
				event.preventDefault()
				event.stopPropagation()
			} else {
				saveForm(event);
			}
			form.classList.add('was-validated')
		});
	});
	ajax('GET', actionContacts, r => getContacts(document.getElementById('phonebookForm'), r.responseText));
	ajax('GET', actionAccounts, r => getAccounts(document.getElementById('accountForm'), r.responseText));
	switchAdvanced();
}

function saveConfiguration() {
	localStorage.setItem("configuration", JSON.stringify(configuration));
}

function initUrlText() {
	let urlTextField = document.querySelector('#urlText');
	urlTextField.value = configuration.url;
	urlTextField.addEventListener('change', function() {
        configuration.url = this.value;
        saveConfiguration();
    });
}

function initAdvancedMode() {
	let advancedCheckbox = document.getElementById('advancedSwitcher');
	advancedCheckbox.checked = configuration.advancedMode;
	advancedCheckbox.addEventListener('change', function() {
        switchAdvanced();
    });
}

function initLogfile() {
	logfile = document.querySelector("#logfile");
	let logsleep = document.querySelector('#logsleep');
	logsleep.addEventListener('change', function() {
        setLogTimeout(this.value);
    });
}

function jsonToForm(f, data) {
	for(var prop in data){
		let field = f.querySelector('*[name='+prop+']');
		if (field != null) {
			field.value = data[prop];
		}
	}
};

function showInfo(msg) {
	document.querySelector('#infoText').innerHTML = msg;
	toastInfo.show();
}

function showError(msg) {
	document.querySelector('#errorText').innerHTML = msg;
	toastError.show();
}

function ajax(protocol, action, success, data) {
	let xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if (this.readyState == 4) {
			if (this.status == 200) {
				if (success != null) {
					success(this);
				} else {
					showInfo(this.responseText === "" ? "Done" : this.responseText);
				}
			} else {
				showError(this.status + ": " + this.statusText);
			}
		}
	};
	xhttp.open(protocol, createUrl(action), true);
	xhttp.send(data);
}

function createUrl(action) {
	return (configuration.url + action).replace(/([^:]\/)\/+/g, "$1");
}

function loadForm(form) {
	let action = form.getAttribute('action');
	if (action != null) {
		ajax('GET', action, function(response) {
			if(response.responseText != '') {
				jsonToForm(form, JSON.parse(response.responseText.replace(',}', '}')));
			}
		});
	}
}

function saveForm(event) {
	event.preventDefault();
	let form = event.target;
	let action = form.getAttribute('action');
	if (action != null) {
		action += '?' + new URLSearchParams(new FormData(event.target)).toString();
		ajax('PUT', action);
	} else {
		saveFile(form);
	}
}

function saveFile(form) {
	let d;
	let action;
	if (form.id == 'indexFileForm') {
		action = '/file/html';
		d = getFile(form);
	} else if (form.id == 'otaFileForm') {
		action = '/api/ota';
		d = getFile(form);
	} else if (form.id == 'phonebookForm') {
		action = actionContacts;
		d = getContacts(form);
	} else if (form.id == 'accountForm') {
		action = actionAccounts;
		d = getAccounts(form);
	}
	ajax('PUT', action, null, d);
}

function getFile(form) {
	return form.getElementsByTagName('input')[0].files[0];
}

function getLine(lines, arg) {
	for (var i = 0; i < lines.length; i++) {
		if (lines[i].startsWith(arg + '=')) {
			return lines[i].split('=')[1];
		}
	}
	return '';
}

function getAccounts(form, content) {
	let d = ''
	let account;
	d = '<' + form.querySelector('#accountSipTextField').value;
	d += ';transport=udp>;'
	d += 'auth_pass=' + form.querySelector('#accountPasswordTextField').value + ";";
	d += 'outbound="' + form.querySelector('#accountOutboundTextField').value + '"';
	if (content != null && content != '') {
		let lines = content.split(';');
		form.querySelector('#accountSipTextField').value = lines[0].split('<')[1];
		form.querySelector('#accountPasswordTextField').value = getLine(lines, 'auth_pass');
		form.querySelector('#accountOutboundTextField').value = getLine(lines, 'outbound').split("\"")[1];
	}
	return d;
}

function getContacts(form, content) {
	let d = '';
	let contacts = new Array();
	if (content != null && content != '') {
		let lines = content.split('\n');
		[].forEach.call(lines, function(line) {
			if(line != "") {
				let words = line.split(/\"\s*</);
				words[0] = words[0].split(/\"/)[1];
				words[1] = words[1].split(/>/)[0];
				contacts[contacts.length] = [words[0], words[1]];
			}
		});
	}
	let divs = form.querySelectorAll('.kt-contact');
	for(var i = 0; i < divs.length ; i++) {
		let div = divs[i];
		let inputs = div.querySelectorAll('input');
		d += '"' + inputs[0].value + '" <' + inputs[1].value + '>\n';
		if (contacts.length > 0) {
			inputs[0].value = contacts[i][0];
			inputs[1].value = contacts[i][1];
		}
	};
	return d;
}

function menu(l) {
    page = l.getAttribute('href');
    document.querySelectorAll('.page').forEach(function(item) {
        if(page == '#' + item.id) {
        	if (document.querySelector("#navbar-toggler").offsetLeft >= 0) {
            	bsCollapse.hide();
            }
            item.classList.remove( 'hidden' );
        } else {
            item.classList.add( 'hidden' );
        }
    });
}

function showSettings() {
    ajax('GET', '/settingses/1', function(response) {
		o = JSON.parse(response.responseText);
    	delete o.indexPage;
    	delete o._links;
		document.getElementById('codeBlock').innerHTML = JSON.stringify(o, null, 3);
	});
}

function switchAdvanced() {
	let v = document.getElementById('advancedSwitcher').checked;
	configuration.advancedMode = v;
	saveConfiguration();
	let list = document.querySelectorAll('.kt-advanced');
	var i;
	for (i = 0; i < list.length; i++) {
		list[i].style.display = v ? 'block' : 'none';
	}
}

function setLogTimeout(v) {
	if (logTimeout != null) {
		clearInterval(logTimeout);
	}
	if (v >= 0) {
		logTimeout = setTimeout(function() {
			ajax('GET', '/api/logfile', function(response) {
				let scrolling = ((logfile.scrollTop + logfile.offsetHeight) > logfile.scrollHeight);
				let selectionStart = logfile.selectionStart;
				let selectionEnd = logfile.selectionEnd;
				logfile.value += response.responseText;
				if (scrolling) {
					logfile.scrollTop = logfile.scrollHeight;
				}
				logfile.selectionStart = selectionStart;
				logfile.selectionEnd = selectionEnd;
				setLogTimeout(v);
			});
		}, v * 1000);
	}
}

function clearLogfile() {
	logfile.value = '';
}

function getVersion() {
    ajax('GET', '/api/appversion');
}

function getMac() {
    ajax('GET', '/api/mac');
}

function restart() {
    ajax('GET', '/api/restart');
}

function factoryReset() {
    ajax('GET', '/api/factory_reset');
}

function testCall() {
    ajax('GET', '/api/testcall');
}
</script>
</body>
</html>
